<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>DB Lead | Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg-dark:#0a0118;--bg-card:rgba(255,255,255,.03);--glass:rgba(255,255,255,.08);--border:rgba(255,255,255,.12);--accent:#f59e0b;--accent-light:#fbbf24;--green:#10b981;--yellow:#f59e0b;--red:#ef4444;--blue:#3b82f6;--cyan:#06b6d4;}
*{box-sizing:border-box;margin:0;padding:0;}
body{margin:0;font-family:'Inter',sans-serif;color:#fff;background:radial-gradient(circle at 20% 20%,rgba(245,158,11,.15),transparent 50%),radial-gradient(circle at 80% 80%,rgba(239,68,68,.12),transparent 50%),linear-gradient(135deg,#0a0118 0%,#1a0b2e 100%);min-height:100vh;}
.nav{display:flex;justify-content:space-between;align-items:center;padding:20px 40px;background:rgba(255,255,255,.05);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);}
.nav-brand{display:flex;align-items:center;gap:12px;}
.icon{width:40px;height:40px;background:linear-gradient(135deg,var(--accent),#fb923c);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;}
.nav-title{font-weight:700;font-size:20px;background:linear-gradient(135deg,#fff,var(--accent-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.admin-badge{background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;color:var(--accent-light);text-transform:uppercase;}
.btn{padding:10px 20px;border:none;border-radius:12px;cursor:pointer;font-weight:600;font-size:14px;}
.btn-back{background:linear-gradient(135deg,var(--cyan),#22d3ee);color:#0a0118;}
.container{max-width:1200px;margin:40px auto;padding:0 20px;}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:24px;padding:32px;backdrop-filter:blur(20px);}
.card-title{font-size:24px;font-weight:700;background:linear-gradient(135deg,#fff,var(--accent-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px;}
.stat-card{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center;}
.stat-value{font-size:32px;font-weight:700;background:linear-gradient(135deg,var(--accent-light),#fb923c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.table-container{overflow-x:auto;border-radius:16px;border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;}
thead{background:rgba(245,158,11,.1);border-bottom:2px solid rgba(245,158,11,.3);}
th,td{padding:16px;font-size:14px;}
.date-badge{background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.3);padding:4px 10px;border-radius:8px;font-size:12px;color:#60a5fa;}
.time-badge{background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.3);padding:4px 10px;border-radius:8px;font-size:12px;color:#34d399;}
.btn-delete{background:rgba(239,68,68,.15);color:var(--red);border:1px solid rgba(239,68,68,.3);padding:8px 16px;border-radius:10px;cursor:pointer;font-size:13px;}
.toast-wrap{position:fixed;right:24px;bottom:24px;display:flex;flex-direction:column;gap:12px;z-index:9999;}
.toast{min-width:300px;background:rgba(10,10,20,.95);color:#fff;border:1px solid var(--border);border-radius:16px;padding:16px 20px;display:flex;align-items:center;gap:12px;animation:toastIn .4s forwards;}
.toast-icon{background:var(--green);width:24px;height:24px;border-radius:50%;display:flex;justify-content:center;align-items:center;}
@keyframes toastIn{from{opacity:0;transform:translateX(80px);}to{opacity:1;transform:translateX(0);}}
</style>
</head>

<body>
<div class="nav">
  <div class="nav-brand">
    <div class="icon">üëë</div>
    <div>
      <div class="nav-title">Admin Panel</div>
      <div class="admin-badge">Administrator</div>
    </div>
  </div>
  <button class="btn btn-back" onclick="location.href='index.html'">‚Üê Back</button>
</div>

<div class="container">
  <div class="stats">
    <div class="stat-card"><div class="stat-value" id="totalBookings">0</div><div>Total</div></div>
    <div class="stat-card"><div class="stat-value" id="todayBookings">0</div><div>Today</div></div>
    <div class="stat-card"><div class="stat-value" id="upcomingBookings">0</div><div>Upcoming</div></div>
  </div>

  <div class="card">
    <div class="card-header"><div class="card-title">All Appointments</div></div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Booked By</th><th>Date</th><th>Time</th><th>Status</th><th>Booked At</th><th>Action</th></tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="6" style="text-align:center;padding:20px;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const db = supabase.createClient(
 "https://vnmwgvizkxtqdinfvtla.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZubXdndml6a3h0cWRpbmZ2dGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNTkxMDEsImV4cCI6MjA3NzgzNTEwMX0.Iw0Ftt97SJ502W_X8y9HZw-8acDipQndJEKRqpfew6o"
);

// Ensure we are logged in and are admin
db.auth.getSession().then(async ({ data }) => {
  if (!data?.session) return location.href="login.html";
  const user = data.session.user;

  const { data: role } = await db
    .from("team_members")
    .select("provider_type")
    .eq("email", user.email)
    .maybeSingle();

  if (!role || role.provider_type !== "admin") {
    toast("‚ùå Access Denied: Admin Only", "error");
    setTimeout(()=>location.href="index.html",1200);
    return;
  }

  await loadAppointments();

  // Realtime subscribe
  db.channel('room:appointments-admin')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'appointments' }, () => loadAppointments())
    .subscribe();
});

function toast(msg,type="success"){
  const box=document.getElementById("toasts");
  const el=document.createElement("div");
  el.className=`toast ${type}`;
  el.innerHTML=`<div class="toast-icon">${type==="success"?"‚úì":"‚úï"}</div>${msg}`;
  box.appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

async function loadAppointments(){
  const { data, error } = await db
    .from("appointments")
    .select("*")
    .order("date", { ascending:false })
    .order("slot_time", { ascending:true });

  if (error) { toast("Error loading", "error"); return; }

  const today = new Date().toISOString().split("T")[0];
  totalBookings.textContent = data.length;
  todayBookings.textContent = data.filter(a => a.date === today).length;
  upcomingBookings.textContent = data.filter(a => a.date >= today && a.status === 'booked').length;

  tableBody.innerHTML = "";
  data.forEach(a=>{
    const d = new Date(a.created_at);
    const displayTime = (a.slot_time || '').toString().slice(0,5); // HH:MM
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${a.booked_by}</td>
      <td><span class="date-badge">${a.date}</span></td>
      <td><span class="time-badge">${displayTime}</span></td>
      <td>${a.status}</td>
      <td>${d.toLocaleString()}</td>
      <td>
        <button class="btn-delete" onclick="deleteAppt(${a.id}, '${a.booked_by.replace(/'/g,"&#39;")}')">üóë Cancel</button>
      </td>`;
    tableBody.appendChild(tr);
  });
}

async function deleteAppt(id, name){
  if(!confirm(`Cancel ${name}'s slot?`)) return;

  const { error } = await db.from("appointments").delete().eq("id", id);
  if (error) { toast("Cancel failed", "error"); return; }

  toast(`‚úÖ Cancelled ${name}`);
  await loadAppointments();
  localStorage.setItem("refreshSlots", Date.now());
}
</script>
</body>
</html>
