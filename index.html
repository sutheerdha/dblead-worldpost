<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>DB Lead | Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg-dark: #0a0118;
  --bg-card: rgba(255,255,255,.03);
  --glass: rgba(255,255,255,.08);
  --border: rgba(255,255,255,.12);
  --accent: #8b5cf6;
  --accent-light: #a78bfa;
  --green: #10b981;
  --yellow: #f59e0b;
  --red: #ef4444;
  --blue: #3b82f6;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Inter', -apple-system, sans-serif;
  color: #fff;
  background: 
    radial-gradient(circle at 20% 20%, rgba(139,92,246,.15), transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(59,130,246,.12), transparent 50%),
    linear-gradient(135deg, var(--bg-dark) 0%, #1a0b2e 100%);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Animated background particles */
.bg-particles {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
  opacity: 0.4;
}

.particle {
  position: absolute;
  border-radius: 50%;
  background: radial-gradient(circle, var(--accent-light), transparent);
  animation: float 20s infinite ease-in-out;
}

.particle:nth-child(1) { width: 300px; height: 300px; top: 10%; left: 10%; animation-delay: 0s; }
.particle:nth-child(2) { width: 200px; height: 200px; top: 60%; left: 70%; animation-delay: 5s; }
.particle:nth-child(3) { width: 250px; height: 250px; top: 80%; left: 20%; animation-delay: 10s; }

@keyframes float {
  0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.3; }
  50% { transform: translate(50px, 50px) scale(1.1); opacity: 0.5; }
}

/* Navigation */
.nav {
  position: relative;
  z-index: 100;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 40px;
  background: rgba(255,255,255,.05);
  backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  box-shadow: 0 8px 32px rgba(0,0,0,.3);
}

.nav-brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.nav-brand .icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 18px;
  box-shadow: 0 4px 12px rgba(139,92,246,.3);
}

.nav-brand h2 {
  font-weight: 700;
  font-size: 20px;
  background: linear-gradient(135deg, #fff, var(--accent-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.nav-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.user-badge {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 16px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 12px;
  font-weight: 500;
  font-size: 14px;
}

.user-avatar {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
}

button {
  padding: 10px 20px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: inherit;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0,0,0,.3);
}

.btn-admin {
  background: linear-gradient(135deg, #f59e0b, #fb923c);
  color: #fff;
  display: none;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.btn-admin:hover {
  box-shadow: 0 8px 20px rgba(245, 158, 11, 0.5);
}

.btn-logout {
  background: rgba(239,68,68,.15);
  color: var(--red);
  border: 1px solid rgba(239,68,68,.3);
}

.btn-logout:hover {
  background: rgba(239,68,68,.25);
  border-color: rgba(239,68,68,.5);
}

/* Main Container */
.container {
  position: relative;
  z-index: 10;
  max-width: 1100px;
  margin: 40px auto;
  padding: 0 20px;
}

.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 32px;
  backdrop-filter: blur(20px) saturate(180%);
  box-shadow: 
    0 30px 60px rgba(0,0,0,.5),
    inset 0 1px 0 rgba(255,255,255,.1);
}

.card-header {
  margin-bottom: 28px;
}

.card-title {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 8px;
  background: linear-gradient(135deg, #fff, var(--accent-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.card-subtitle {
  color: rgba(255,255,255,.6);
  font-size: 14px;
}

/* Date Picker */
.date-section {
  margin-bottom: 32px;
}

.date-label {
  display: block;
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 10px;
  color: rgba(255,255,255,.9);
}

#datePick {
  width: 100%;
  padding: 14px 18px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: var(--glass);
  color: #fff;
  font-size: 15px;
  font-family: inherit;
  font-weight: 500;
  transition: all 0.3s ease;
  cursor: pointer;
}

#datePick:hover {
  border-color: var(--accent-light);
  background: rgba(255,255,255,.1);
}

#datePick:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(139,92,246,.2);
}

/* Legend */
.legend {
  display: flex;
  gap: 20px;
  margin-bottom: 24px;
  padding: 16px;
  background: rgba(255,255,255,.02);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.05);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: rgba(255,255,255,.7);
}

.legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid;
}

.legend-dot.free { background: var(--green); border-color: var(--green); }
.legend-dot.mine { background: var(--yellow); border-color: var(--yellow); }
.legend-dot.taken { background: var(--red); border-color: var(--red); }

/* Slots Grid */
.slots {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 16px;
}

.slot {
  position: relative;
  padding: 20px 16px;
  border-radius: 16px;
  text-align: center;
  font-weight: 600;
  font-size: 15px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
  user-select: none;
  border: 1px solid;
  overflow: hidden;
}

.slot::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,.1), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.slot:hover::before {
  opacity: 1;
}

.slot-time {
  display: block;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 4px;
}

.slot-label {
  display: block;
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  opacity: 0.8;
}

/* Slot States */
.slot.free {
  background: linear-gradient(135deg, rgba(16,185,129,.15), rgba(16,185,129,.05));
  border-color: rgba(16,185,129,.4);
  color: var(--green);
}

.slot.free:hover {
  background: linear-gradient(135deg, rgba(16,185,129,.25), rgba(16,185,129,.1));
  border-color: rgba(16,185,129,.6);
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(16,185,129,.2);
}

.slot.mine {
  background: linear-gradient(135deg, rgba(245,158,11,.15), rgba(245,158,11,.05));
  border-color: rgba(245,158,11,.4);
  color: var(--yellow);
}

.slot.mine:hover {
  background: linear-gradient(135deg, rgba(245,158,11,.25), rgba(245,158,11,.1));
  border-color: rgba(245,158,11,.6);
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(245,158,11,.2);
}

.slot.taken {
  background: linear-gradient(135deg, rgba(239,68,68,.15), rgba(239,68,68,.05));
  border-color: rgba(239,68,68,.4);
  color: var(--red);
  cursor: not-allowed;
  opacity: 0.7;
}

.slot.taken:hover {
  transform: none;
}

.slot.admin-cancel {
  cursor: pointer;
  opacity: 1;
}

.slot.admin-cancel:hover {
  background: linear-gradient(135deg, rgba(239,68,68,.25), rgba(239,68,68,.1));
  border-color: rgba(239,68,68,.6);
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(239,68,68,.2);
}

/* Pulse Animation */
@keyframes pulse {
  0% { 
    box-shadow: 0 0 0 0 rgba(139,92,246,0.7);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 0 20px rgba(139,92,246,0);
    transform: scale(1.05);
  }
  100% { 
    box-shadow: 0 0 0 0 rgba(139,92,246,0);
    transform: scale(1);
  }
}

.pulse { 
  animation: pulse 1s ease-out 1;
}

/* Toast Notifications */
.toast-wrap {
  position: fixed;
  right: 24px;
  bottom: 24px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 9999;
}

.toast {
  min-width: 300px;
  background: rgba(10,10,20,.95);
  color: #fff;
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px 20px;
  box-shadow: 0 16px 40px rgba(0,0,0,.6);
  backdrop-filter: blur(20px);
  display: flex;
  align-items: center;
  gap: 12px;
  transform: translateX(400px);
  opacity: 0;
  animation: toastIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

.toast-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}

.toast.success {
  border-color: rgba(16,185,129,.5);
}

.toast.success .toast-icon {
  background: var(--green);
  color: #fff;
}

.toast.error {
  border-color: rgba(239,68,68,.5);
}

.toast.error .toast-icon {
  background: var(--red);
  color: #fff;
}

.toast.info {
  border-color: rgba(59,130,246,.5);
}

.toast.info .toast-icon {
  background: var(--blue);
  color: #fff;
}

.toast-message {
  font-size: 14px;
  font-weight: 500;
  flex: 1;
}

@keyframes toastIn {
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Loading State */
.loading {
  text-align: center;
  padding: 40px;
  color: rgba(255,255,255,.5);
}

.spinner {
  width: 40px;
  height: 40px;
  margin: 0 auto 16px;
  border: 3px solid rgba(255,255,255,.1);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
  .nav {
    padding: 16px 20px;
  }
  
  .nav-brand h2 {
    font-size: 16px;
  }
  
  .container {
    margin: 20px auto;
  }
  
  .card {
    padding: 24px;
  }
  
  .slots {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
  }
  
  .legend {
    flex-wrap: wrap;
    gap: 12px;
  }
  
  .user-badge {
    display: none;
  }
}
</style>
</head>

<body>

<!-- Animated Background -->
<div class="bg-particles">
  <div class="particle"></div>
  <div class="particle"></div>
  <div class="particle"></div>
</div>

<!-- Navigation -->
<div class="nav">
  <div class="nav-brand">
    <div class="icon">DB</div>
    <h2>DB Team ‚Äî CEPT India</h2>
  </div>
  <div class="nav-right">
    <button id="adminBtn" class="btn-admin" onclick="location.href='admin.html'">
      üëë Admin Panel
    </button>
    <div class="user-badge">
      <div class="user-avatar" id="userAvatar"></div>
      <span id="who"></span>
    </div>
    <button class="btn-logout" onclick="logout()">Sign out</button>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <div class="card">
    <div class="card-header">
      <div class="card-title">Karthika Madam Appointment Booking</div>
      <div class="card-subtitle">Select a date and book your preferred time slot</div>
    </div>

    <div class="date-section">
      <label class="date-label">Select Date</label>
      <input type="date" id="datePick">
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-dot free"></div>
        <span>Available</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot mine"></div>
        <span>Your Booking</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot taken"></div>
        <span>Booked</span>
      </div>
    </div>

    <div class="slots" id="slots">
      <div class="loading">
        <div class="spinner"></div>
        <div>Loading slots...</div>
      </div>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ========================
   Supabase Client
======================== */
const db = supabase.createClient(
  "https://vnmwgvizkxtqdinfvtla.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZubXdndml6a3h0cWRpbmZ2dGxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNTkxMDEsImV4cCI6MjA3NzgzNTEwMX0.Iw0Ftt97SJ502W_X8y9HZw-8acDipQndJEKRqpfew6o"
);

/* ========================
   Runtime State
======================== */
let displayName = localStorage.getItem("displayName");
if(!displayName){ location.href="login.html"; }

who.textContent = displayName;
userAvatar.textContent = displayName.charAt(0).toUpperCase();

let lastAction = null;
let userRole = null;
let currentUserId = null;
let isAdmin = false;

// Check user role and show admin button if admin
db.auth.getSession().then(({data})=>{
  if(data?.session){
    currentUserId = data.session.user.id;
    userRole = data.session.user.raw_user_meta_data?.role;
    
    // Check if user is admin (Karthika) - check multiple variations
    const displayNameLower = displayName.toLowerCase();
    if(userRole === "admin" || 
       displayNameLower.includes("karthika") || 
       displayName === "Karthika Madam"){
      isAdmin = true;
      adminBtn.style.display = "inline-block";
      console.log("Admin access granted for:", displayName);
    }
  }
  // Load slots after checking admin status
  loadSlots();
});

/* ========================
   WhatsApp Recipients
======================== */
const PHONE_BOOK = {
  "Karthika Madam": "+919710783387",
  "Karthika": "+919710783387",
  "Bharath": "+919739595784",
  "Bharath Sir": "+919739595784",
  "Ramesh": "+919056163143",
  "Ramesh Bro": "+919056163143",
  "Sutheerdha": "+919515143345"
};

function sendWhatsApp(date, time, bookedBy) {
  const recipients = [PHONE_BOOK["Karthika Madam"], PHONE_BOOK[bookedBy]].filter(Boolean);
  const msg = `üóìÔ∏è Karthika Madam Appointment Confirmed%0A%0Aüë§ Name: ${encodeURIComponent(bookedBy)}%0AüìÖ Date: ${encodeURIComponent(date)}%0A‚è∞ Time: ${encodeURIComponent(time)}%0A%0A‚Äî DB Team, CEPT India`;
  
  recipients.forEach((num) => {
    const plain = (num||"").replace(/\+/g,"");
    const url = `https://wa.me/${plain}?text=${msg}`;
    window.open(url, "_blank");
  });
}

/* ========================
   Time Slots
======================== */
function getSlots(){
  const times=[];
  let t=new Date("2000-01-01T08:00");
  for(let i=0;i<=24;i++){
    times.push(t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
    t = new Date(t.getTime()+30*60000);
  }
  return times;
}
const TIMES = getSlots();

datePick.valueAsDate = new Date();
datePick.onchange = loadSlots;

/* ========================
   Toast Notifications
======================== */
function toast(message, type="success"){
  const el = document.createElement("div");
  el.className = `toast ${type}`;
  
  const icon = document.createElement("div");
  icon.className = "toast-icon";
  icon.textContent = type === "success" ? "‚úì" : type === "error" ? "‚úï" : "‚Ñπ";
  
  const msg = document.createElement("div");
  msg.className = "toast-message";
  msg.textContent = message;
  
  el.appendChild(icon);
  el.appendChild(msg);
  toasts.appendChild(el);
  
  setTimeout(()=>{
    el.style.transform = "translateX(400px)";
    el.style.opacity = "0";
    setTimeout(()=>el.remove(), 400);
  }, 3000);
}

/* ========================
   Load Slots
======================== */
async function loadSlots(){
  const date = datePick.value;
  
  slots.innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <div>Loading slots...</div>
    </div>
  `;
  
  const { data } = await db.from("appointments")
    .select("id,user_id,date,slot_time,booked_by")
    .eq("date", date);

  const { data: sessionData } = await db.auth.getSession();
  const userId = sessionData.session.user.id;
  
  console.log("Loading slots - isAdmin:", isAdmin, "displayName:", displayName);

  slots.innerHTML = "";
  
  TIMES.forEach(time=>{
    const match = data?.find(r=>r.slot_time===time);
    let el = document.createElement("div");

    if(!match){
      // Free slot - members can book, admin cannot
      el.className = "slot free";
      el.innerHTML = `
        <span class="slot-time">${time}</span>
        <span class="slot-label">Available</span>
      `;
      
      // Only non-admin users can book slots
      if(!isAdmin){
        el.onclick = ()=>book(date, time, userId, el);
      } else {
        // Admin sees free slots but can't book
        el.style.cursor = "not-allowed";
        el.style.opacity = "0.7";
      }
      
    } else if (match.user_id === userId){
      // User's own booking - can cancel
      el.className = "slot mine";
      el.innerHTML = `
        <span class="slot-time">${time}</span>
        <span class="slot-label">Your Booking</span>
      `;
      el.onclick = ()=>cancel(match.id, match.user_id, el, false);
      
    } else {
      // Booked by someone else
      el.className = "slot taken";
      // Extract just the name without @dblead.local
      const displayBookedBy = match.booked_by.replace(/@dblead\.local$/i, '').replace(/@.*$/, '');
      el.innerHTML = `
        <span class="slot-time">${time}</span>
        <span class="slot-label">${displayBookedBy.toUpperCase()}</span>
      `;
      
      // ONLY ADMIN can cancel other people's bookings
      if(isAdmin){
        el.classList.add("admin-cancel");
        el.style.cursor = "pointer";
        el.onclick = ()=>cancel(match.id, match.user_id, el, true, displayBookedBy);
        console.log("Admin can cancel:", displayBookedBy, "at", time);
      } else {
        el.style.cursor = "not-allowed";
      }
    }

    // Pulse animation for last action
    if(lastAction && lastAction.date===date && lastAction.time===time){
      el.classList.add("pulse");
      setTimeout(()=>el.classList.remove("pulse"), 1000);
    }

    slots.appendChild(el);
  });
}

/* ========================
   Book Slot
======================== */
async function book(date, time, userId, el){
  const { error } = await db.from("appointments").insert({
    user_id: userId,
    date: date,
    slot_time: time,
    booked_by: displayName
  });
  
  if(error){
    toast("Slot already taken or error occurred.", "error");
    return;
  }

  lastAction = {date, time};
  toast("‚úÖ Slot booked successfully!");
  sendWhatsApp(date, time, displayName);
  loadSlots();
}

/* ========================
   Cancel Slot
======================== */
async function cancel(id, slotUserId, el, isAdminCancel = false, bookedByName = null){
  // Confirm cancellation
  const confirmMsg = isAdminCancel 
    ? `üëë ADMIN: Cancel ${bookedByName}'s booking for this slot?`
    : "Cancel your booking?";
    
  if(!confirm(confirmMsg)) return;
  
  console.log("Cancelling appointment:", {id, slotUserId, isAdminCancel, bookedByName});
  
  // Delete the appointment - admin can delete any appointment
  const { error } = await db.from("appointments")
    .delete()
    .eq("id", id);
    
  if(error){
    console.error("Cancel error:", error);
    toast("Could not cancel booking: " + error.message, "error");
    return;
  }

  lastAction = {date: datePick.value, time: el?.querySelector('.slot-time')?.textContent || ""};
  
  if(isAdminCancel){
    toast(`üëë Admin cancelled ${bookedByName}'s booking`, "info");
  } else {
    toast("‚ùé Booking cancelled");
  }
  
  // Reload slots to reflect changes
  await loadSlots();
}

/* ========================
   Logout
======================== */
function logout(){
  db.auth.signOut();
  localStorage.clear();
  location.href = "login.html";
}

/* Initialize */
// Don't load slots here - wait for auth check to complete
// loadSlots() is now called after auth check
</script>

</body>
</html>